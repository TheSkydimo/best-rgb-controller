---
import { DEFAULT_LOCALE, SUPPORTED_LOCALES, type Locale } from "~/i18n/config";

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const supportedLocales = Array.from(SUPPORTED_LOCALES);
const defaultLocale = DEFAULT_LOCALE;
const storageKey = "preferredLocale";
---

<script define:vars={{ storageKey, supportedLocales, defaultLocale, locale }}>
  (function () {
    const supportedLocaleSet = new Set(supportedLocales);

    const safeNormalizeLocale = (value) => {
      if (typeof value !== "string") return undefined;
      const normalized = value.toLowerCase().split("-")[0];
      return supportedLocaleSet.has(normalized) ? normalized : undefined;
    };

    const readStoredLocale = () => {
      try {
        return safeNormalizeLocale(
          window.localStorage.getItem(storageKey) ?? undefined,
        );
      } catch {
        return undefined;
      }
    };

    const writeStoredLocale = (value) => {
      if (!value) return;
      try {
        window.localStorage.setItem(storageKey, value);
      } catch {
        /* storage might be unavailable (private mode, etc.) */
      }
    };

    const buildLocalePath = (value) => {
      if (!value) return "/";
      return value === defaultLocale ? "/" : `/${value}/`;
    };

    // Remember the user's last chosen/visited locale
    // and use it to redirect from the default landing page (`/`)
    // next time they come back.
    const storedLocale = readStoredLocale();
    const currentPath = window.location.pathname || "/";

    // 首次访问：没有存储的偏好语言时，记住当前页面语言即可。
    if (!storedLocale) {
      writeStoredLocale(locale);
      return;
    }

    // 如果是站内跳转到默认语言（例如从 /zh/ 点击切换到 /），
    // 视为用户主动选择英语：更新偏好语言为当前 locale，并不要再自动跳回其它语言。
    try {
      const referrer = document.referrer;
      const referrerUrl = referrer ? new URL(referrer) : null;
      const isInternalReferrer =
        referrerUrl && referrerUrl.origin === window.location.origin;

      if (
        isInternalReferrer &&
        locale === defaultLocale &&
        storedLocale !== locale
      ) {
        writeStoredLocale(locale);
        return;
      }
    } catch {
      // 忽略 referrer 解析异常
    }

    // 对于直接从外部访问首页（没有站内 referrer）且用户首选语言不是默认语言时，
    // 仍然自动跳转到其首选语言版本。
    if (locale === defaultLocale && storedLocale !== defaultLocale) {
      const isRootPath = currentPath === "/" || currentPath === "/index.html";
      if (isRootPath) {
        const targetPath = buildLocalePath(storedLocale);
        window.location.replace(targetPath);
        return;
      }
    }

    // 当用户访问一个非默认语言页面且与已存储偏好不同时，同样视为主动切换语言。
    if (locale !== defaultLocale && storedLocale !== locale) {
      writeStoredLocale(locale);
    }
  })();
</script>
