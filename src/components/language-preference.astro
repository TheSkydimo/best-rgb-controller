---
import { DEFAULT_LOCALE, SUPPORTED_LOCALES, type Locale } from "~/i18n/config";

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const supportedLocales = Array.from(SUPPORTED_LOCALES);
const defaultLocale = DEFAULT_LOCALE;
const storageKey = "preferredLocale";
---

<script define:vars={{ storageKey, supportedLocales, defaultLocale, locale }}>
  (function () {
    const supportedLocaleSet = new Set(supportedLocales);

    const safeNormalizeLocale = (value) => {
      if (typeof value !== "string") return undefined;
      const normalized = value.toLowerCase().split("-")[0];
      return supportedLocaleSet.has(normalized) ? normalized : undefined;
    };

    const readStoredLocale = () => {
      try {
        return safeNormalizeLocale(
          window.localStorage.getItem(storageKey) ?? undefined,
        );
      } catch {
        return undefined;
      }
    };

    const writeStoredLocale = (value) => {
      if (!value) return;
      try {
        window.localStorage.setItem(storageKey, value);
      } catch {
        /* storage might be unavailable (private mode, etc.) */
      }
    };

    const buildLocalePath = (value) => {
      if (!value) return "/";
      return value === defaultLocale ? "/" : `/${value}/`;
    };

    // Remember the user's last chosen/visited locale
    // and use it to redirect from the default landing page (`/`)
    // next time they come back.
    const storedLocale = readStoredLocale();

    // Always remember at least the current page locale on first visit.
    if (!storedLocale) {
      writeStoredLocale(locale);
      return;
    }

    const currentPath = window.location.pathname || "/";

    // If user is on the default locale page but has a different preferred locale,
    // automatically redirect them to their preferred language version.
    if (locale === defaultLocale && storedLocale !== defaultLocale) {
      const targetPath = buildLocalePath(storedLocale);

      // Only redirect from the real landing path to avoid surprises on other routes.
      if (currentPath === "/" || currentPath === "/index.html") {
        window.location.replace(targetPath);
        return;
      }
    }

    // When user visits a non-default locale page that differs from stored one,
    // treat this as an explicit preference change and update storage.
    if (locale !== defaultLocale && storedLocale !== locale) {
      writeStoredLocale(locale);
    }
  })();
</script>
